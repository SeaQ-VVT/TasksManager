<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Manager</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }

    /* Nav bar */
    .nav-bar {
      background-color: #334155;
      color: white;
      padding: 0.35rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      transition: transform .25s ease, opacity .25s ease;
      font-size: 0.85rem;
    }
    /* Auto-hide */
    .nav-hidden { transform: translateY(-95%); opacity: 0; }
    .nav-visible { transform: translateY(0); opacity: 1; }

    /* Hot zone to reveal nav */
    #navHotZone {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 16px;
      z-index: 1100;
    }
    @media (pointer: coarse) {
      #navHotZone { height: 40px; }
    }
    @supports(padding: max(0px)) {
      .nav-bar { padding-top: max(1rem, env(safe-area-inset-top)); }
    }
  </style>
</head>

<body class="bg-gray-100 p-4 pt-20">
  <!-- Navigation Bar -->
  <div class="nav-bar" id="navBar">
    <h1 class="text-xl font-bold">Task Manager</h1>
    <div class="flex items-center space-x-4">
      <div id="status" class="text-sm">Not logged in</div>
      <div id="navButtons" class="flex items-center space-x-4 hidden">
        <button id="showChangePassModalBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">Change Password</button>
        <button id="showCreateUserModalBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-medium transition-colors hidden">Create New User</button>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-medium transition-colors">Log out</button>
      </div>
    </div>
  </div>

  <div class="w-full flex justify-center mt-6">
    <div class="bg-white rounded-2xl shadow-xl w-full p-8 border border-gray-200">
      <!-- Login Section -->
      <div id="loginSection" class="space-y-4">
        <h3 class="text-xl font-semibold text-gray-700 text-center mb-4">Sign in</h3>
        <input id="loginUsername" type="text" placeholder="Username (e.g., admin)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
        <button id="loginBtn" class="w-full p-3 mt-4 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition duration-200">Sign in</button>
      </div>

      <!-- Main Content -->
      <div id="mainContent" class="hidden">
        <hr class="my-6 border-gray-200">
        <div id="projectControls" class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-gray-800">Projects</h3>
          <button id="addProjectBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">Add New Project</button>
        </div>
        <div id="projectArea" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="taskBoard" class="mt-6"></div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePassModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">Change your password</h3>
      <input id="currentPassInput" type="password" placeholder="Current password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <input id="newPassInput" type="password" placeholder="New password" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <input id="confirmPassInput" type="password" placeholder="Confirm new password" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <div class="mt-4 flex space-x-2">
        <button id="changePassBtn" class="flex-1 p-3 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition duration-200">Change</button>
        <button id="cancelChangePassBtn" class="flex-1 p-3 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition duration-200">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">Create new user</h3>
      <input id="newEmail" type="email" placeholder="New user email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <input id="newPassword" type="password" placeholder="New password" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <input id="newDisplayName" type="text" placeholder="Display name (optional)" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <div class="mt-4 flex space-x-2">
        <button id="createUserBtn" class="flex-1 p-3 text-white bg-green-500 hover:bg-green-600 rounded-lg font-medium transition duration-200">Create</button>
        <button id="cancelCreateUserBtn" class="flex-1 p-3 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition duration-200">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="projectModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
      <h3 id="projectModalTitle" class="text-xl font-semibold text-gray-700 mb-4 text-center">Create new project</h3>
      <input id="projectTitle" type="text" placeholder="Project title" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <textarea id="projectDescription" placeholder="Project description (optional)" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 resize-none h-32"></textarea>

      <input id="projectStartDate" type="date" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <input id="projectEndDate" type="date" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
      <textarea id="projectComment" placeholder="Notes / Comments" class="w-full mt-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 resize-none h-24"></textarea>

      <div class="mt-4 flex space-x-2">
        <button id="saveProjectBtn" class="flex-1 p-3 text-white bg-green-500 hover:bg-green-600 rounded-lg font-medium transition duration-200">Save project</button>
        <button id="cancelProjectBtn" class="flex-1 p-3 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition duration-200">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
      <h3 class="text-xl font-semibold text-gray-700 mb-4">Confirm deletion</h3>
      <p class="text-gray-600 mb-6">Are you sure you want to delete this project? This action cannot be undone.</p>
      <div class="flex space-x-2">
        <button id="confirmDeleteBtn" class="flex-1 p-3 text-white bg-red-600 hover:bg-red-700 rounded-lg font-medium transition duration-200">Delete</button>
        <button id="cancelDeleteBtn" class="flex-1 p-3 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition duration-200">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Message Modal -->
  <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
      <p id="messageText" class="text-gray-800 mb-6"></p>
      <button id="messageOkBtn" class="w-full p-3 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition duration-200">OK</button>
    </div>
  </div>

  <!-- App scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
      updatePassword, createUserWithEmailAndPassword, updateProfile,
      EmailAuthProvider, reauthenticateWithCredential
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCW49METqezYoUKSC1N0Pi3J83Ptsf9hA8",
      authDomain: "task-manager-d18aa.firebaseapp.com",
      projectId: "task-manager-d18aa",
      storageBucket: "task-manager-d18aa.appspot.com",
      messagingSenderId: "1080268498085",
      appId: "1:1080268498085:web:767434c6a2c013b961d94c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAIL = "admin@myapp.com";
    let currentUser = null;

    // display name (email prefix)
    function displayName(email) {
      if (!email) return "Anonymous";
      return String(email).split("@")[0];
    }

    // Message modal
    function showMessage(message) {
      const modal = document.getElementById('messageModal');
      document.getElementById('messageText').textContent = message;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    document.getElementById('messageOkBtn').addEventListener('click', () => hideModal('messageModal'));

    // Buttons
    document.getElementById('showChangePassModalBtn').addEventListener('click', () => {
      document.getElementById('changePassModal').classList.remove('hidden');
      document.getElementById('changePassModal').classList.add('flex');
    });
    document.getElementById('cancelChangePassBtn').addEventListener('click', () => hideModal('changePassModal'));

    document.getElementById('showCreateUserModalBtn').addEventListener('click', () => {
      document.getElementById('createUserModal').classList.remove('hidden');
      document.getElementById('createUserModal').classList.add('flex');
    });
    document.getElementById('cancelCreateUserBtn').addEventListener('click', () => hideModal('createUserModal'));

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const u = document.getElementById("loginUsername").value.trim();
      const p = document.getElementById("loginPassword").value.trim();
      if (!u || !p) { showMessage("Please enter your username and password."); return; }
      try {
        await signInWithEmailAndPassword(auth, `${u}@myapp.com`, p);
      } catch (err) {
        let errorMessage = "Incorrect username or password.";
        if (err.code === "auth/invalid-email") errorMessage = "Invalid email format.";
        else if (err.code === "auth/user-not-found") errorMessage = "User does not exist.";
        showMessage(errorMessage);
        console.error(err);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
      } finally {
        // clear password field after logout (requirement #3)
        const pw = document.getElementById('loginPassword');
        if (pw) pw.value = "";
      }
    });

    document.getElementById("changePassBtn").addEventListener("click", async () => {
      const currentPass = document.getElementById("currentPassInput").value.trim();
      const newPass = document.getElementById("newPassInput").value.trim();
      const confirmPass = document.getElementById("confirmPassInput").value.trim();

      if (!currentPass || !newPass || !confirmPass) { showMessage("Please fill all password fields."); return; }
      if (newPass !== confirmPass) { showMessage("New password and confirmation do not match."); return; }

      try {
        const user = auth.currentUser;
        if (!user || !user.email) { showMessage("You must be logged in."); return; }

        // Reauthenticate with current password BEFORE updating
        const cred = EmailAuthProvider.credential(user.email, currentPass);
        await reauthenticateWithCredential(user, cred);

        await updatePassword(user, newPass);
        showMessage("Password changed successfully.");
        hideModal('changePassModal');

        // clear fields
        document.getElementById("currentPassInput").value = "";
        document.getElementById("newPassInput").value = "";
        document.getElementById("confirmPassInput").value = "";
      } catch (err) {
        let msg = "Failed to change password.";
        if (err.code === "auth/wrong-password") msg = "Current password is incorrect.";
        else if (err.code === "auth/weak-password") msg = "New password is too weak.";
        else if (err.code === "auth/requires-recent-login") msg = "Please sign in again and retry.";
        showMessage(msg);
        console.error(err);
      }
    });

    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const email = document.getElementById("newEmail").value.trim();
      const pass = document.getElementById("newPassword").value.trim();
      const name = document.getElementById("newDisplayName").value.trim();
      if (!email || !pass) { showMessage("Please enter email and password."); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if (name) {
          await updateProfile(cred.user, { displayName: name });
          await setDoc(doc(db, "users", cred.user.uid), { displayName: name, email: cred.user.email });
        }
        showMessage(`User created: ${email}`);
        hideModal('createUserModal');
      } catch (err) {
        let errorMessage = "Failed to create user.";
        if (err.code === "auth/invalid-email") errorMessage = "Invalid email format.";
        else if (err.code === "auth/email-already-in-use") errorMessage = "This email is already in use.";
        else if (err.code === "auth/weak-password") errorMessage = "Password is too weak.";
        showMessage(errorMessage);
        console.error(err);
      }
    });

    // --- Auth State Change Listener ---
    onAuthStateChanged(auth, user => {
      currentUser = user;
      const status = document.getElementById("status");
      const loginSection = document.getElementById("loginSection");
      const mainContent = document.getElementById("mainContent");
      const navButtons = document.getElementById("navButtons");
      const showCreateUserModalBtn = document.getElementById("showCreateUserModalBtn");
      const addProjectBtn = document.getElementById("addProjectBtn");

      // Default UI
      loginSection.classList.remove('hidden');
      mainContent.classList.add('hidden');
      navButtons.classList.add('hidden');
      status.textContent = "Not logged in";

      // also clear password field when logged out
      const pw = document.getElementById('loginPassword');
      if (pw) pw.value = "";

      if (!user) return;

      // Logged in
      loginSection.classList.add('hidden');
      mainContent.classList.remove('hidden');
      navButtons.classList.remove('hidden');

      const email = user.email;
      const isAdmin = email === ADMIN_EMAIL;

      // Show account name only (remove role)
      status.textContent = `Account: ${displayName(email)}`;

      if (isAdmin) {
        showCreateUserModalBtn.classList.remove('hidden');
        addProjectBtn.classList.remove('hidden');
      } else {
        showCreateUserModalBtn.classList.add('hidden');
        addProjectBtn.classList.add('hidden');
      }
    });

    // ==== Auto-hide nav (unchanged) ====
    const navBar = document.getElementById('navBar');
    const hot = document.createElement('div');
    hot.id = 'navHotZone';
    document.body.appendChild(hot);

    let hideTimer;
    function showNav(ms = 1800) {
      navBar.classList.remove('nav-hidden');
      navBar.classList.add('nav-visible');
      clearTimeout(hideTimer);
      hideTimer = setTimeout(hideNav, ms);
    }
    function hideNav() {
      navBar.classList.add('nav-hidden');
      navBar.classList.remove('nav-visible');
    }

    const isTouch =
      window.matchMedia?.('(pointer: coarse)').matches ||
      'ontouchstart' in window ||
      navigator.maxTouchPoints > 0;

    hideNav();

    if (isTouch) {
      showNav(1200);
      hot.addEventListener('touchstart', () => showNav(3000), { passive: true });
      hot.addEventListener('click', () => showNav(3000));
      navBar.addEventListener('touchstart', () => showNav(4000), { passive: true });

      let lastY = window.scrollY;
      window.addEventListener('scroll', () => {
        const y = window.scrollY;
        if (y < lastY - 5) showNav(1500);
        else if (y > lastY + 5) hideNav();
        lastY = y;
      }, { passive: true });
    } else {
      hot.addEventListener('mouseenter', () => showNav());
      navBar.addEventListener('mouseenter', () => showNav(3000));
      navBar.addEventListener('mouseleave', hideNav);
    }
  </script>

  <!-- Modules -->
  <script type="module" src="addproject.js"></script>
  <script type="module" src="tasks.js"></script>
</body>
</html>


